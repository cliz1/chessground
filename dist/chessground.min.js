var ao=["white","black"];var $=["a","b","c","d","e","f","g","h"],Q=["1","2","3","4","5","6","7","8"];var lo=[...Q].reverse(),ve=$.flatMap(e=>Q.map(o=>e+o)),b=e=>ve[8*e[0]+e[1]],m=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];var we=ve.map(m);function co(e){let o,n=()=>(o===void 0&&(o=e()),o);return n.clear=()=>{o=void 0},n}var uo=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let o=performance.now()-e;return e=void 0,o}}},Y=e=>e==="white"?"black":"white",F=(e,o)=>(e[0]-o[0])**2+(e[1]-o[1])**2,I=(e,o)=>e.role===o.role&&e.color===o.color,po=(e,o)=>e[0]===o[0]&&e[1]===o[1],G=e=>(o,n)=>[(n?o[0]:7-o[0])*e.width/8,(n?7-o[1]:o[1])*e.height/8],C=(e,o)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px)`},Be=(e,o,n=1)=>{e.style.transform=`translate(${o[0]}px,${o[1]}px) scale(${n})`},re=(e,o)=>{e.style.visibility=o?"visible":"hidden"},O=e=>{if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(e.targetTouches?.[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Pe=e=>e.button===2,K=(e,o)=>{let n=document.createElement(e);return o&&(n.className=o),n};function Se(e,o,n){let r=m(e);return o||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}var P=(e,o)=>Math.abs(e-o),W=(e,o,n,r)=>P(e,n)*P(o,r)===2,j=(e,o,n,r)=>e===n!=(o===r),U=(e,o,n,r)=>P(e,n)===P(o,r)&&e!==n,J=(e,o,n,r)=>j(e,o,n,r)||U(e,o,n,r),te=(e,o,n,r)=>W(e,o,n,r)||j(e,o,n,r),ie=(e,o,n,r)=>W(e,o,n,r)||U(e,o,n,r),ae=(e,o,n,r)=>W(e,o,n,r)||J(e,o,n,r),Oe=(e,o,n,r)=>Math.max(P(e,n),P(o,r))===1,se=(e,o,n,r)=>Math.max(P(e,n),P(o,r))===1,Re=(e,o,n,r,t)=>P(e,n)===1&&r===o+(t?1:-1),Me=(e,o,n,r,t)=>{let i=t?1:-1;return e===n&&(r===o+i||r===o+2*i&&(t?o<=1:o>=6))};function le(e,o,n,r,t,...i){let s=t===!1?-1:1,d=e===n&&r===o+s,c=Math.abs(n-e)===1&&r===o+s;return d||c}var Z=(e,o,n,r)=>{let t=P(e,n),i=P(o,r);return t===0&&i>0&&i<=2||i===0&&t>0&&t<=2};function De(e,o,n,r){return Math.abs(n-e)===1&&Math.abs(r-o)===1}var ce=(e,o,n,r)=>{let t=n-e,i=r-o;if(t&&i&&Math.abs(t)!==Math.abs(i))return[];let s=Math.sign(t),d=Math.sign(i),c=[],a=e+s,l=o+d;for(;a!==n||l!==r;)c.push([a,l]),a+=s,l+=d;return c.map(p=>b(p))},mo=e=>{let o=m(e),n=[];return o[0]>0&&n.push([o[0]-1,o[1]]),o[0]<7&&n.push([o[0]+1,o[1]]),n.map(b)},de=(e,o)=>{let n=m(e);return n[1]+=o,b(n)};var k=e=>e.friendlies.has(b(e.pos2)),pn=e=>e.enemies.has(b(e.pos2)),ee=(e,o,n)=>ce(...e,...o).some(r=>n.has(r)),fo=(e,o,n)=>{let r=n.enemies.get(e);if(r?.role!=="pawn")return!1;let t=r.color==="white"?1:-1,i=m(e),s=m(o);return Me(...i,...s,r.color==="white")&&!ee(i,[s[0],s[1]+t],n.allPieces)},mn=(e,o,n)=>{let r=n.enemies.get(e);return r?.role==="pawn"&&Re(...m(e),...m(o),r.color==="white")&&(n.friendlies.has(o)||ke(de(o,r.color==="white"?-1:1),n.friendlies,n.enemies,n.lastMove))},fn=e=>[...e.enemies.keys()].some(o=>fo(o,b(e.pos2),e)),Ve=(e,o)=>{let n=e.pos2;return[...e.enemies].some(([r,t])=>{let i=m(r);return!o?.includes(t.role)&&((t.role==="pawn"||t.role==="painter")&&Re(...i,...n,t.color==="white")||t.role==="knight"&&W(...i,...n)||t.role==="bishop"&&U(...i,...n)||t.role==="rook"&&j(...i,...n)||t.role==="queen"&&J(...i,...n)||t.role==="champion"&&te(...i,...n)||t.role=="princess"&&ie(...i,...n)||t.role==="amazon"&&ae(...i,...n)||t.role==="mann"&&Oe(...i,...n)||t.role==="wizard"&&Z(...i,...n)||t.role==="royalpainter"&&J(...i,...n)||t.role==="rollingsnare"&&(se(...i,...n)||Z(...i,...n))||t.role==="snare"&&le(...i,...n,t.color==="white")&&!e.allPieces.has(b(n))||t.role==="king"&&se(...i,...n))&&(!["bishop","rook","queen","champion","princess"].includes(t.role)||!ee(i,n,e.allPieces))})},A=e=>k(e)&&(ke(b(e.pos2),e.friendlies,e.enemies,e.lastMove)||Ve(e)),ke=(e,o,n,r)=>{if(r&&e!==r[1])return!1;let t=m(e),i=o.get(e);return i?.role==="pawn"&&t[1]===(i.color==="white"?3:4)&&(!r||P(m(r[0])[1],t[1])===2)&&[1,-1].some(s=>n.get(b([t[0]+s,t[1]]))?.role==="pawn")},gn=e=>{if(e.unrestrictedPremoves)return!0;let o=ce(...e.pos1,...e.pos2),n=o.filter(r=>e.friendlies.has(r));return!n.length||n.length===1&&ke(n[0],e.friendlies,e.enemies,e.lastMove)&&!o.includes(de(n[0],e.color==="white"?-1:1))},bn=e=>{if(e.unrestrictedPremoves)return!0;let o=ce(...e.pos1,...e.pos2),n=o.filter(a=>e.enemies.has(a));if(n.length>1)return!1;if(!n.length)return!0;let r=n[0],t=e.enemies.get(r);if(!t||t.role!=="pawn")return!0;let i=t.color==="white"?1:-1,s=de(r,i),d=[...mo(s).filter(a=>mn(r,a,e)),...[s,de(s,i)].filter(a=>fo(r,a,e))],c=[...o,b(e.pos1)];return d.some(a=>!c.includes(a))},pe=e=>gn(e)&&bn(e),hn=e=>{let o=e.color==="white"?1:-1;return P(e.pos1[0],e.pos2[0])>1?!1:P(e.pos1[0],e.pos2[0])?e.pos2[1]!==e.pos1[1]+o?!1:e.unrestrictedPremoves||pn(e)?!0:k(e)?Ve(e):fn(e)||ke(b([e.pos2[0],e.pos2[1]+o]),e.friendlies,e.enemies,e.lastMove)||Ve(e,["pawn"]):Me(...e.pos1,...e.pos2,e.color==="white")&&pe({...e,pos2:[e.pos2[0],e.pos2[1]+o]})},yn=e=>W(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e)),Le=e=>U(...e.pos1,...e.pos2)&&pe(e)&&(e.unrestrictedPremoves||!k(e)||A(e)),ze=e=>j(...e.pos1,...e.pos2)&&pe(e)&&(e.unrestrictedPremoves||!k(e)||A(e)),vn=e=>Le(e)||ze(e),wn=e=>te(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e))&&(!j(...e.pos1,...e.pos2)||!ee(e.pos1,e.pos2,e.allPieces)),Pn=e=>ie(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e))&&(!U(...e.pos1,...e.pos2)||!ee(e.pos1,e.pos2,e.allPieces)),Sn=e=>ae(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e))&&(!j(...e.pos1,...e.pos2)||!ee(e.pos1,e.pos2,e.allPieces)||!U(...e.pos1,...e.pos2)||!ee(e.pos1,e.pos2,e.allPieces)),Mn=e=>Oe(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e)),Dn=e=>Le(e)||ze(e),kn=e=>P(e.pos1[0],e.pos2[0])?!1:Me(...e.pos1,...e.pos2,e.color==="white")&&pe({...e,pos2:[e.pos2[0],e.pos2[1]+(e.color==="white"?1:-1)]}),Cn=e=>{let o=b(e.pos2);return le(...e.pos1,...e.pos2,e.color==="white")&&!e.allPieces.has(o)},Kn=e=>(se(...e.pos1,...e.pos2)||Z(...e.pos1,...e.pos2))&&(e.unrestrictedPremoves||!k(e)||A(e)),En=e=>Z(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e)),An=e=>De(...e.pos1,...e.pos2)&&pe(e)&&(e.unrestrictedPremoves||!k(e)||A(e)),Nn=e=>se(...e.pos1,...e.pos2)&&(e.unrestrictedPremoves||!k(e)||A(e))||e.canCastle&&e.pos1[1]===e.pos2[1]&&e.pos1[1]===(e.color==="white"?0:7)&&(e.pos1[0]===4&&(e.pos2[0]===2&&e.rookFilesFriendlies.includes(0)||e.pos2[0]===6&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.pos2[0]))&&(e.unrestrictedPremoves||ce(...e.pos1,e.pos2[0]>e.pos1[0]?7:1,e.pos2[1]).map(o=>e.allPieces.get(o)).every(o=>!o||I(o,{role:"rook",color:e.color}))),xn={pawn:hn,knight:yn,bishop:Le,rook:ze,queen:vn,champion:wn,princess:Pn,amazon:Sn,king:Nn,mann:Mn,painter:kn,snare:Cn,wizard:En,archer:An,royalpainter:Dn,rollingsnare:Kn};function Fe(e,o){let n=e.pieces,r=e.premovable.castle,t=!!e.premovable.unrestrictedPremoves,i=n.get(o);if(!i||i.color===e.turnColor)return[];let s=i.color,d=new Map([...n].filter(([u,g])=>g.color===s)),c=new Map([...n].filter(([u,g])=>g.color===Y(s))),a=m(o),l=xn[i.role],p={pos1:a,allPieces:n,friendlies:d,enemies:c,unrestrictedPremoves:t,color:s,canCastle:r,rookFilesFriendlies:Array.from(n).filter(([u,g])=>u[1]===(s==="white"?"1":"8")&&g.color===s&&g.role==="rook").map(([u])=>m(u)[0]),lastMove:e.lastMove};return we.filter(u=>l({...p,pos2:u})).map(b)}function S(e,...o){e&&setTimeout(()=>e(...o),1)}function go(e){e.orientation=Y(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function bo(e,o){for(let[n,r]of o)r?e.pieces.set(n,r):e.pieces.delete(n)}function ho(e,o){if(e.check=void 0,o===!0&&(o=e.turnColor),o)for(let[n,r]of e.pieces)r.role==="king"&&r.color===o&&(e.check=n)}function Hn(e,o,n,r){x(e),e.premovable.current=[o,n],S(e.premovable.events.set,o,n,r)}function N(e){e.premovable.current&&(e.premovable.current=void 0,S(e.premovable.events.unset))}function qn(e,o,n){N(e),e.predroppable.current={role:o,key:n},S(e.predroppable.events.set,o,n)}function x(e){let o=e.predroppable;o.current&&(o.current=void 0,S(o.events.unset))}function Tn(e,o,n){if(!e.autoCastle)return!1;let r=e.pieces.get(o);if(!r||r.role!=="king")return!1;let t=m(o),i=m(n);if(t[1]!==0&&t[1]!==7||t[1]!==i[1])return!1;t[0]===4&&!e.pieces.has(n)&&(i[0]===6?n=b([7,i[1]]):i[0]===2&&(n=b([0,i[1]])));let s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(o),e.pieces.delete(n),t[0]<i[0]?(e.pieces.set(b([6,i[1]]),r),e.pieces.set(b([5,i[1]]),s)):(e.pieces.set(b([2,i[1]]),r),e.pieces.set(b([3,i[1]]),s)),!0)}function Ge(e,o,n){let r=e.pieces.get(o),t=e.pieces.get(n);if(o===n||!r)return!1;let i=t&&t.color!==r.color?t:void 0;return n===e.selected&&D(e),S(e.events.move,o,n,i),r.role==="archer"&&i&&(()=>{let s=m(o),d=m(n),c=Math.abs(d[0]-s[0]),a=Math.abs(d[1]-s[1]);return Math.max(c,a)>1&&c===a})()?(e.animation.skipAnims=new Set([o]),e.pieces.delete(n),e.pieces.set(o,r),e.lastMove=[o,n],e.check=void 0,S(e.events.change),i||!0):(Tn(e,o,n)||(e.pieces.set(n,r),e.pieces.delete(o)),e.lastMove=[o,n],e.check=void 0,S(e.events.change),i||!0)}function Ce(e,o,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return S(e.events.dropNewPiece,o,n),e.pieces.set(n,o),e.lastMove=[n],e.check=void 0,S(e.events.change),e.movable.dests=void 0,e.turnColor=Y(e.turnColor),!0}function yo(e,o,n){let r=Ge(e,o,n);return r&&(e.movable.dests=void 0,e.turnColor=Y(e.turnColor),e.animation.current=void 0),r}function We(e,o,n){if(Ee(e,o,n)){let r=yo(e,o,n);if(r){let t=e.hold.stop();D(e);let i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:t};return r!==!0&&(i.captured=r),S(e.movable.events.after,o,n,i),!0}}else if(On(e,o,n))return Hn(e,o,n,{ctrlKey:e.stats.ctrlKey}),D(e),!0;return D(e),!1}function Ke(e,o,n,r){let t=e.pieces.get(o);t&&(Bn(e,o,n)||r)?(e.pieces.delete(o),Ce(e,t,n,r),S(e.movable.events.afterNewPiece,t.role,n,{premove:!1,predrop:!1})):t&&Rn(e,o,n)?qn(e,t.role,n):(N(e),x(e)),e.pieces.delete(o),D(e)}function me(e,o,n){if(S(e.events.select,o),e.selected){if(e.selected===o&&!e.draggable.enabled){D(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==o&&We(e,e.selected,o)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(vo(e,o)||Ie(e,o))&&($e(e,o),e.hold.start())}function $e(e,o){e.selected=o,Ie(e,o)?e.premovable.customDests||(e.premovable.dests=Fe(e,o)):e.premovable.dests=void 0}function D(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function vo(e,o){let n=e.pieces.get(o);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}var Ee=(e,o,n)=>o!==n&&vo(e,o)&&(e.movable.free||!!e.movable.dests?.get(o)?.includes(n));function Bn(e,o,n){let r=e.pieces.get(o);return!!r&&(o===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function Ie(e,o){let n=e.pieces.get(o);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}var On=(e,o,n)=>o!==n&&Ie(e,o)&&(e.premovable.customDests?.get(o)??Fe(e,o)).includes(n);function Rn(e,o,n){let r=e.pieces.get(o),t=e.pieces.get(n);return!!r&&(!t||t.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function wo(e,o){let n=e.pieces.get(o);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function Po(e){let o=e.premovable.current;if(!o)return!1;let n=o[0],r=o[1],t=!1;if(Ee(e,n,r)){let i=yo(e,n,r);if(i){let s={premove:!0};i!==!0&&(s.captured=i),S(e.movable.events.after,n,r,s),t=!0}}return N(e),t}function So(e,o){let n=e.predroppable.current,r=!1;if(!n)return!1;if(o(n)){let t={role:n.role,color:e.movable.color};Ce(e,t,n.key)&&(S(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return x(e),r}function fe(e){N(e),x(e),D(e)}function je(e){e.movable.color=e.movable.dests=e.animation.current=void 0,fe(e)}function H(e,o,n){let r=Math.floor(8*(e[0]-n.left)/n.width);o||(r=7-r);let t=7-Math.floor(8*(e[1]-n.top)/n.height);return o||(t=7-t),r>=0&&r<8&&t>=0&&t<8?b([r,t]):void 0}function Mo(e,o,n,r){let t=m(e),i=we.filter(a=>po(t,a)||J(t[0],t[1],a[0],a[1])||W(t[0],t[1],a[0],a[1])||te(t[0],t[1],a[0],a[1])||ie(t[0],t[1],a[0],a[1])||ae(t[0],t[1],a[0],a[1])||le(t[0],t[1],a[0],a[1],n)||Z(t[0],t[1],a[0],a[1])||De(t[0],t[1],a[0],a[1])),d=i.map(a=>Se(b(a),n,r)).map(a=>F(o,a)),[,c]=d.reduce((a,l,p)=>a[0]<l?a:[l,p],[d[0],0]);return b(i[c])}var y=e=>e.orientation==="white";var Ze="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Vn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king",c:"champion",i:"princess",a:"amazon",m:"mann",y:"painter",s:"snare",w:"wizard",x:"archer",o:"royalpainter",l:"rollingsnare"},Ln={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k",champion:"c",princess:"i",amazon:"a",mann:"m",painter:"y",snare:"s",wizard:"w",archer:"x",royalpainter:"o",rollingsnare:"l"};function Ae(e){e==="start"&&(e=Ze);let o=new Map,n=7,r=0;for(let t of e)switch(t){case" ":case"[":return o;case"/":if(--n,n<0)return o;r=0;break;case"~":{let i=o.get(b([r-1,n]));i&&(i.promoted=!0);break}default:{let i=t.charCodeAt(0);if(i<57)r+=i-48;else{let s=t.toLowerCase();o.set(b([r,n]),{role:Vn[s],color:t===s?"black":"white"}),++r}}}return o}function Do(e){return lo.map(o=>$.map(n=>{let r=e.get(n+o);if(r){let t=Ln[r.role];return r.color==="white"&&(t=t.toUpperCase()),r.promoted&&(t+="~"),t}else return"1"}).join("")).join("/").replace(/1{2,}/g,o=>o.length.toString())}function _e(e,o){o.animation&&(Xe(e.animation,o.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function Ne(e,o){if(o.movable?.dests&&(e.movable.dests=void 0),o.drawable?.autoShapes&&(e.drawable.autoShapes=[]),Xe(e,o),o.fen&&(e.pieces=Ae(o.fen),e.drawable.shapes=o.drawable?.shapes||[]),"check"in o&&ho(e,o.check||!1),"lastMove"in o&&!o.lastMove?e.lastMove=void 0:o.lastMove&&(e.lastMove=o.lastMove),e.selected&&$e(e,e.selected),_e(e,o),!e.movable.rookCastle&&e.movable.dests){let n=e.movable.color==="white"?"1":"8",r="e"+n,t=e.movable.dests.get(r),i=e.pieces.get(r);if(!t||!i||i.role!=="king")return;e.movable.dests.set(r,t.filter(s=>!(s==="a"+n&&t.includes("c"+n))&&!(s==="h"+n&&t.includes("g"+n))))}}function Xe(e,o){for(let n in o)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(o,n)||(Object.prototype.hasOwnProperty.call(e,n)&&ko(e[n])&&ko(o[n])?Xe(e[n],o[n]):e[n]=o[n])}function ko(e){if(typeof e!="object"||e===null)return!1;let o=Object.getPrototypeOf(e);return o===Object.prototype||o===null}var V=(e,o)=>o.animation.enabled?Wn(e,o):L(e,o);function L(e,o){let n=e(o);return o.dom.redraw(),n}var Qe=(e,o)=>({key:e,pos:m(e),piece:o}),Fn=(e,o)=>o.sort((n,r)=>F(e.pos,n.pos)-F(e.pos,r.pos))[0];function Gn(e,o){let n=new Map,r=[],t=new Map,i=new Map,s=[],d=[],c,a,l;for(let[u,g]of e)i.set(u,Qe(u,g));for(let u of ve)c=o.pieces.get(u),a=i.get(u),c?a?I(c,a.piece)||(s.push(a),d.push(Qe(u,c))):d.push(Qe(u,c)):a&&s.push(a);let p=o.animation?.skipAnims;p&&p.size&&(d=d.filter(u=>!p.has(u.key)),s=s.filter(u=>!p.has(u.key)),o.animation.skipAnims=void 0);for(let u of d)a=Fn(u,s.filter(g=>I(u.piece,g.piece))),a&&(l=[a.pos[0]-u.pos[0],a.pos[1]-u.pos[1]],n.set(u.key,l.concat(l)),r.push(a.key));for(let u of s)r.includes(u.key)||t.set(u.key,u.piece);return{anims:n,fadings:t}}function Co(e,o){let n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}let r=1-(o-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{let t=$n(r);for(let i of n.plan.anims.values())i[2]=i[0]*t,i[3]=i[1]*t;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>Co(e,i))}}function Wn(e,o){let n=new Map(o.pieces),r=e(o),t=Gn(n,o);if(t.anims.size||t.fadings.size){let i=o.animation.current&&o.animation.current.start;o.animation.current={start:performance.now(),frequency:1/o.animation.duration,plan:t},i||Co(o,performance.now())}else o.dom.redraw();return r}var $n=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var In=["green","red","blue","yellow"];function Ko(e,o){if(o.touches&&o.touches.length>1)return;o.stopPropagation(),o.preventDefault(),o.ctrlKey?D(e):fe(e);let n=O(o),r=H(n,y(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:jn(o),snapToValidMove:e.drawable.defaultSnapToValidMove},Eo(e))}function Eo(e){requestAnimationFrame(()=>{let o=e.drawable.current;if(o){let n=H(o.pos,y(e),e.dom.bounds());n||(o.snapToValidMove=!1);let r=o.snapToValidMove?Mo(o.orig,o.pos,y(e),e.dom.bounds()):n;r!==o.mouseSq&&(o.mouseSq=r,o.dest=r!==o.orig?r:void 0,e.dom.redrawNow()),Eo(e)}})}function Ao(e,o){e.drawable.current&&(e.drawable.current.pos=O(o))}function No(e){let o=e.drawable.current;o&&(o.mouseSq&&Un(e.drawable,o),Ye(e))}function Ye(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function xo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Ho(e.drawable))}function jn(e){let o=(e.shiftKey||e.ctrlKey)&&Pe(e),n=e.altKey||e.metaKey||e.getModifierState?.("AltGraph");return In[(o?1:0)+(n?2:0)]}function Un(e,o){let n=t=>t.orig===o.orig&&t.dest===o.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(t=>!n(t))),(!r||r.brush!==o.brush)&&e.shapes.push({orig:o.orig,dest:o.dest,brush:o.brush}),Ho(e)}function Ho(e){e.onChange&&e.onChange(e.shapes)}function qo(e,o){if(!(e.trustAllEvents||o.isTrusted)||o.buttons!==void 0&&o.buttons>1||o.touches&&o.touches.length>1)return;let n=e.dom.bounds(),r=O(o),t=H(r,y(e),n);if(!t)return;let i=e.pieces.get(t),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!i||i.color!==e.turnColor)&&xo(e),o.cancelable!==!1&&(!o.touches||e.blockTouchScroll||i||s||_n(e,r)))o.preventDefault();else if(o.touches)return;let d=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=o.ctrlKey,e.selected&&Ee(e,e.selected,t)?V(p=>me(p,t),e):me(e,t);let a=e.selected===t,l=Vo(e,t);if(i&&l&&a&&wo(e,t)){e.draggable.current={orig:t,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:l,previouslySelected:s,originTarget:o.target,keyHasChanged:!1},l.cgDragging=!0,l.classList.add("dragging");let p=e.dom.elements.ghost;p&&(p.className=`ghost ${i.color} ${i.role}`,C(p,G(n)(m(t),y(e))),re(p,!0)),Je(e)}else d&&N(e),c&&x(e);e.dom.redraw()}function _n(e,o){let n=y(e),r=e.dom.bounds(),t=Math.pow(r.width/8,2);for(let i of e.pieces.keys()){let s=Se(i,n,r);if(F(s,o)<=t)return!0}return!1}function To(e,o,n,r){e.pieces.set("a0",o),e.dom.redraw();let i=O(n);e.draggable.current={orig:"a0",piece:o,origPos:i,pos:i,started:!0,element:()=>Vo(e,"a0"),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},Je(e)}function Je(e){requestAnimationFrame(()=>{let o=e.draggable.current;if(!o)return;e.animation.current?.plan.anims.has(o.orig)&&(e.animation.current=void 0);let n=e.pieces.get(o.orig);if(!n||!I(n,o.piece))_(e);else if(!o.started&&F(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){let t=o.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),o.element=t}let r=e.dom.bounds();C(o.element,[o.pos[0]-r.left-r.width/16,o.pos[1]-r.top-r.height/16]),o.keyHasChanged||=o.orig!==H(o.pos,y(e),r)}Je(e)})}function Bo(e,o){e.draggable.current&&(!o.touches||o.touches.length<2)&&(e.draggable.current.pos=O(o))}function Oo(e,o){let n=e.draggable.current;if(!n)return;if(o.type==="touchend"&&o.cancelable!==!1&&o.preventDefault(),o.type==="touchend"&&n.originTarget!==o.target&&!n.newPiece){e.draggable.current=void 0;return}N(e),x(e);let r=O(o)||n.pos,t=H(r,y(e),e.dom.bounds());t&&n.started&&n.orig!==t?n.newPiece?Ke(e,n.orig,t,n.force):(e.stats.ctrlKey=o.ctrlKey,We(e,n.orig,t)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!t&&(e.pieces.delete(n.orig),S(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===t||!t)?D(e):e.selectable.enabled||D(e),Ro(e),e.draggable.current=void 0,e.dom.redraw()}function _(e){let o=e.draggable.current;o&&(o.newPiece&&e.pieces.delete(o.orig),e.draggable.current=void 0,D(e),Ro(e),e.dom.redraw())}function Ro(e){let o=e.dom.elements;o.ghost&&re(o.ghost,!1)}function Vo(e,o){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===o&&n.tagName==="PIECE")return n;n=n.nextSibling}}function zo(e,o){e.exploding={stage:1,keys:o},e.dom.redraw(),setTimeout(()=>{Lo(e,2),setTimeout(()=>Lo(e,void 0),120)},120)}function Lo(e,o){e.exploding&&(o?e.exploding.stage=o:e.exploding=void 0,e.dom.redraw())}function Fo(e,o){function n(){go(e),o()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),_e(e,r),(r.fen?V:L)(t=>Ne(t,r),e)},state:e,getFen:()=>Do(e.pieces),toggleOrientation:n,setPieces(r){V(t=>bo(t,r),e)},selectSquare(r,t){r?V(i=>me(i,r,t),e):e.selected&&(D(e),e.dom.redraw())},move(r,t){V(i=>Ge(i,r,t),e)},newPiece(r,t){V(i=>Ce(i,r,t),e)},playPremove(){if(e.premovable.current){if(V(Po,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){let t=So(e,r);return e.dom.redraw(),t}return!1},cancelPremove(){L(N,e)},cancelPredrop(){L(x,e)},cancelMove(){L(r=>{fe(r),_(r)},e)},stop(){L(r=>{je(r),_(r)},e)},explode(r){zo(e,r)},setAutoShapes(r){L(t=>t.drawable.autoShapes=r,e)},setShapes(r){L(t=>t.drawable.shapes=r.slice(),e)},getKeyAtDomPos(r){return H(r,y(e),e.dom.bounds())},redrawAll:o,dragNewPiece(r,t,i){To(e,r,t,i)},destroy(){je(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Go(){return{pieces:Ae(Ze),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:uo()}}function Io(){let e=w("defs"),o=M(w("filter"),{id:"cg-filter-blur"});return o.appendChild(M(w("feGaussianBlur"),{stdDeviation:"0.013"})),e.appendChild(o),e}function jo(e,o){let n=e.drawable,r=n.current,t=r&&r.mouseSq?r:void 0,i=new Map,s=e.dom.bounds(),d=n.autoShapes.filter(l=>!l.piece);for(let l of n.shapes.concat(d).concat(t?[t]:[])){if(!l.dest)continue;let p=i.get(l.dest)??new Set,u=He(xe(m(l.orig),e.orientation),s),g=He(xe(m(l.dest),e.orientation),s);p.add(oo(u,g)),i.set(l.dest,p)}let c=[];for(let l of n.shapes.concat(d))c.push({shape:l,current:!1,hash:Wo(l,eo(l.dest,i),!1,s)});t&&c.push({shape:t,current:!0,hash:Wo(t,eo(t.dest,i),!0,s)});let a=c.map(l=>l.hash).join(";");a!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=a,Qn(n,c,o),Yn(c,o,l=>or(e,l,n.brushes,i,s)))}function Qn(e,o,n){for(let r of[n.shapes,n.shapesBelow]){let t=r.querySelector("defs"),i=o.filter(a=>r===n.shapesBelow==!!a.shape.below),s=new Map;for(let a of i.filter(l=>l.shape.dest&&l.shape.brush)){let l=Uo(e.brushes[a.shape.brush],a.shape.modifiers),{key:p,color:u}=Zo(a.shape);p&&u&&s.set(p,{key:p,color:u,opacity:1,lineWidth:1}),s.set(l.key,l)}let d=new Set,c=t.firstElementChild;for(;c;)d.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(let[a,l]of s.entries())d.has(a)||t.appendChild(tr(l))}}function Yn(e,o,n){for(let[r,t]of[[o.shapes,o.custom],[o.shapesBelow,o.customBelow]]){let[i,s]=[r,t].map(a=>a.querySelector("g")),d=e.filter(a=>r===o.shapesBelow==!!a.shape.below),c=new Map;for(let a of d)c.set(a.hash,!1);for(let a of[i,s]){let l=[],p=a.firstElementChild,u;for(;p;)u=p.getAttribute("cgHash"),c.has(u)?c.set(u,!0):l.push(p),p=p.nextElementSibling;for(let g of l)a.removeChild(g)}for(let a of d.filter(l=>!c.get(l.hash)))for(let l of n(a))l.isCustom?s.appendChild(l.el):i.appendChild(l.el)}}function Wo({orig:e,dest:o,brush:n,piece:r,modifiers:t,customSvg:i,label:s,below:d},c,a,l){return[l.width,l.height,a,e,o,n,c&&"-",r&&Jn(r),t&&er(t),i&&`custom-${$o(i.html)},${i.center?.[0]??"o"}`,s&&`label-${$o(s.text)}`,d&&"below"].filter(p=>p).join(",")}function Jn(e){return[e.color,e.role,e.scale].filter(o=>o).join(",")}function er(e){return[e.lineWidth,e.hilite].filter(o=>o).join(",")}function $o(e){let o=0;for(let n=0;n<e.length;n++)o=(o<<5)-o+e.charCodeAt(n)>>>0;return o.toString()}function or(e,{shape:o,current:n,hash:r},t,i,s){let d=He(xe(m(o.orig),e.orientation),s),c=o.dest?He(xe(m(o.dest),e.orientation),s):d,a=o.brush&&Uo(t[o.brush],o.modifiers),l=i.get(o.dest),p=[];if(a){let u=M(w("g"),{cgHash:r});p.push({el:u}),d[0]!==c[0]||d[1]!==c[1]?u.appendChild(rr(o,a,d,c,n,eo(o.dest,i))):u.appendChild(nr(t[o.brush],d,n,s))}if(o.label){let u=o.label;u.fill??=o.brush&&t[o.brush].color;let g=o.brush?void 0:"tr";p.push({el:ir(u,r,d,c,l,g),isCustom:!0})}if(o.customSvg){let u=o.customSvg.center??"orig",[g,v]=u==="label"?Xo(d,c,l).map(R=>R-.5):u==="dest"?c:d,f=M(w("g"),{transform:`translate(${g},${v})`,cgHash:r});f.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${o.customSvg.html}</svg>`,p.push({el:f,isCustom:!0})}return p}function nr(e,o,n,r){let t=ar(),i=(r.width+r.height)/(4*Math.max(r.width,r.height));return M(w("circle"),{stroke:e.color,"stroke-width":t[n?0:1],fill:"none",opacity:_o(e,n),cx:o[0],cy:o[1],r:i-t[1]/2})}function rr(e,o,n,r,t,i){function s(a){let l=lr(i&&!t),p=r[0]-n[0],u=r[1]-n[1],g=Math.atan2(u,p),v=Math.cos(g)*l,f=Math.sin(g)*l,R=Zo(e);return M(w("line"),{stroke:a?R.color:o.color,"stroke-width":sr(o,t)*(a?1.14:1),"stroke-linecap":"round","marker-end":`url(#arrowhead-${a?R.key:o.key})`,opacity:e.modifiers?.hilite?1:_o(o,t),x1:n[0],y1:n[1],x2:r[0]-v,y2:r[1]-f})}if(!e.modifiers?.hilite)return s(!1);let d=M(w("g"),{opacity:o.opacity}),c=M(w("g"),{filter:"url(#cg-filter-blur)"});return c.appendChild(cr(n,r)),c.appendChild(s(!0)),d.appendChild(c),d.appendChild(s(!1)),d}function tr(e){let o=M(w("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return o.appendChild(M(w("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),o.setAttribute("cgKey",e.key),o}function ir(e,o,n,r,t,i){let d=.4*.75**e.text.length,c=Xo(n,r,t),a=i==="tr"?.4:0,l=M(w("g"),{transform:`translate(${c[0]+a},${c[1]-a})`,cgHash:o});l.appendChild(M(w("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:e.fill??"#666",stroke:"white"}));let p=M(w("text"),{"font-size":d,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return p.innerHTML=e.text,l.appendChild(p),l}function xe(e,o){return o==="white"?e:[7-e[0],7-e[1]]}function eo(e,o){return(e&&o.has(e)&&o.get(e).size>1)===!0}function w(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function M(e,o){for(let n in o)Object.prototype.hasOwnProperty.call(o,n)&&e.setAttribute(n,o[n]);return e}function Uo(e,o){return o?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(o.lineWidth||e.lineWidth),key:[e.key,o.lineWidth].filter(n=>n).join("")}:e}function ar(){return[3/64,4/64]}function sr(e,o){return(e.lineWidth||10)*(o?.85:1)/64}function Zo(e){let o=e.modifiers?.hilite;return{key:o&&typeof o=="string"?`hilite-${o.replace("#","")}`:void 0,color:o}}function _o(e,o){return(e.opacity||1)*(o?.9:1)}function lr(e){return(e?20:10)/64}function He(e,o){let n=Math.min(1,o.width/o.height),r=Math.min(1,o.height/o.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function cr(e,o){let n={from:[Math.floor(Math.min(e[0],o[0])),Math.floor(Math.min(e[1],o[1]))],to:[Math.ceil(Math.max(e[0],o[0])),Math.ceil(Math.max(e[1],o[1]))]};return M(w("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function oo(e,o,n=!0){let r=Math.atan2(o[1]-e[1],o[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function dr(e,o){return Math.sqrt([e[0]-o[0],e[1]-o[1]].reduce((n,r)=>n+r*r,0))}function Xo(e,o,n){let r=dr(e,o),t=oo(e,o,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;let i=oo(e,o);(n.has((i+1)%16)||n.has((i+15)%16))&&i&1&&(r-=.4)}return[e[0]-Math.cos(t)*r,e[1]-Math.sin(t)*r].map(i=>i+.5)}function Yo(e,o){e.innerHTML="",e.classList.add("cg-wrap");for(let l of ao)e.classList.toggle("orientation-"+l,o.orientation===l);e.classList.toggle("manipulable",!o.viewOnly);let n=K("cg-container");e.appendChild(n);let r=K("cg-board");n.appendChild(r);let t,i,s,d,c;if(o.drawable.visible&&([t,i]=["cg-shapes-below","cg-shapes"].map(l=>Qo(l,!0)),[s,d]=["cg-custom-below","cg-custom-svgs"].map(l=>Qo(l,!1)),c=K("cg-auto-pieces"),n.appendChild(t),n.appendChild(s),n.appendChild(i),n.appendChild(d),n.appendChild(c)),o.coordinates){let l=o.orientation==="black"?" black":"",p=o.ranksPosition==="left"?" left":"";if(o.coordinatesOnSquares){let u=o.orientation==="white"?g=>g+1:g=>8-g;$.forEach((g,v)=>n.appendChild(no(Q.map(f=>g+f),"squares rank"+u(v)+l+p)))}else n.appendChild(no(Q,"ranks"+l+p)),n.appendChild(no($,"files"+l))}let a;return o.draggable.enabled&&o.draggable.showGhost&&(a=K("piece","ghost"),re(a,!1),n.appendChild(a)),{board:r,container:n,wrap:e,ghost:a,shapes:i,shapesBelow:t,custom:d,customBelow:s,autoPieces:c}}function Qo(e,o){let n=M(w("svg"),{class:e,viewBox:o?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return n.appendChild(w("g")),o&&n.appendChild(Io()),n}function no(e,o){let n=K("coords",o),r;for(let t of e)r=K("coord"),r.textContent=t,n.appendChild(r);return n}function Jo(e,o){if(!e.dropmode.active)return;N(e),x(e);let n=e.dropmode.piece;if(n){e.pieces.set("a0",n);let r=O(o),t=r&&H(r,y(e),e.dom.bounds());t&&Ke(e,"a0",t)}e.dom.redraw()}function on(e,o){let n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(o).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",t=>t.preventDefault()),e.viewOnly)return;let r=pr(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function nn(e,o){let n=[];if("ResizeObserver"in window||n.push(ge(document.body,"chessground.resize",o)),!e.viewOnly){let r=en(e,Bo,Ao),t=en(e,Oo,No);for(let s of["touchmove","mousemove"])n.push(ge(document,s,r));for(let s of["touchend","mouseup"])n.push(ge(document,s,t));let i=()=>e.dom.bounds.clear();n.push(ge(document,"scroll",i,{capture:!0,passive:!0})),n.push(ge(window,"resize",i,{passive:!0}))}return()=>n.forEach(r=>r())}function ge(e,o,n,r){return e.addEventListener(o,n,r),()=>e.removeEventListener(o,n,r)}var pr=e=>o=>{e.draggable.current?_(e):e.drawable.current?Ye(e):o.shiftKey||Pe(o)?e.drawable.enabled&&Ko(e,o):e.viewOnly||(e.dropmode.active?Jo(e,o):qo(e,o))},en=(e,o,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||o(e,r)};function tn(e){let o=y(e),n=G(e.dom.bounds()),r=e.dom.elements.board,t=e.pieces,i=e.animation.current,s=i?i.plan.anims:new Map,d=i?i.plan.fadings:new Map,c=e.draggable.current,a=fr(e),l=new Set,p=new Set,u=new Map,g=new Map,v,f,R,X,E,oe,qe,q,Te,he;for(f=r.firstChild;f;){if(v=f.cgKey,sn(f))if(R=t.get(v),E=s.get(v),oe=d.get(v),X=f.cgPiece,f.cgDragging&&(!c||c.orig!==v)&&(f.classList.remove("dragging"),C(f,n(m(v),o)),f.cgDragging=!1),!oe&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),R){if(E&&f.cgAnimating&&X===be(R)){let h=m(v);h[0]+=E[2],h[1]+=E[3],f.classList.add("anim"),C(f,n(h,o))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),C(f,n(m(v),o)),e.addPieceZIndex&&(f.style.zIndex=ro(m(v),o)));X===be(R)&&(!oe||!f.cgFading)?l.add(v):oe&&X===be(oe)?(f.classList.add("fading"),f.cgFading=!0):to(u,X,f)}else to(u,X,f);else if(ln(f)){let h=f.className;a.get(v)===h?p.add(v):to(g,h,f)}f=f.nextSibling}for(let[h,ne]of a)if(!p.has(h)){Te=g.get(ne),he=Te&&Te.pop();let T=n(m(h),o);if(he)he.cgKey=h,C(he,T);else{let B=K("square",ne);B.cgKey=h,C(B,T),r.insertBefore(B,r.firstChild)}}for(let[h,ne]of t)if(E=s.get(h),!l.has(h))if(qe=u.get(be(ne)),q=qe&&qe.pop(),q){q.cgKey=h,q.cgFading&&(q.classList.remove("fading"),q.cgFading=!1);let T=m(h);e.addPieceZIndex&&(q.style.zIndex=ro(T,o)),E&&(q.cgAnimating=!0,q.classList.add("anim"),T[0]+=E[2],T[1]+=E[3]),C(q,n(T,o))}else{let T=be(ne),B=K("piece",T),ye=m(h);B.cgPiece=T,B.cgKey=h,E&&(B.cgAnimating=!0,ye[0]+=E[2],ye[1]+=E[3]),C(B,n(ye,o)),e.addPieceZIndex&&(B.style.zIndex=ro(ye,o)),r.appendChild(B)}for(let h of u.values())rn(e,h);for(let h of g.values())rn(e,h)}function an(e){let o=y(e),n=G(e.dom.bounds()),r=e.dom.elements.board.firstChild;for(;r;)(sn(r)&&!r.cgAnimating||ln(r))&&C(r,n(m(r.cgKey),o)),r=r.nextSibling}function io(e){let o=e.dom.elements.wrap.getBoundingClientRect(),n=e.dom.elements.container,r=o.height/o.width,t=Math.floor(o.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,i=t*r;n.style.width=t+"px",n.style.height=i+"px",e.dom.bounds.clear(),e.addDimensionsCssVarsTo?.style.setProperty("---cg-width",t+"px"),e.addDimensionsCssVarsTo?.style.setProperty("---cg-height",i+"px")}var sn=e=>e.tagName==="PIECE",ln=e=>e.tagName==="SQUARE";function rn(e,o){for(let n of o)e.dom.elements.board.removeChild(n)}function ro(e,o){let r=e[1];return`${o?10-r:3+r}`}var be=e=>`${e.color} ${e.role}`;function fr(e){let o=new Map;if(e.lastMove&&e.highlight.lastMove)for(let t of e.lastMove)z(o,t,"last-move");if(e.check&&e.highlight.check&&z(o,e.check,"check"),e.selected&&(z(o,e.selected,"selected"),e.movable.showDests)){let t=e.movable.dests?.get(e.selected);if(t)for(let s of t)z(o,s,"move-dest"+(e.pieces.has(s)?" oc":""));let i=e.premovable.customDests?.get(e.selected)??e.premovable.dests;if(i)for(let s of i)z(o,s,"premove-dest"+(e.pieces.has(s)?" oc":""))}let n=e.premovable.current;if(n)for(let t of n)z(o,t,"current-premove");else e.predroppable.current&&z(o,e.predroppable.current.key,"current-premove");let r=e.exploding;if(r)for(let t of r.keys)z(o,t,"exploding"+r.stage);return e.highlight.custom&&e.highlight.custom.forEach((t,i)=>{z(o,i,t)}),o}function z(e,o,n){let r=e.get(o);r?e.set(o,`${r} ${n}`):e.set(o,n)}function to(e,o,n){let r=e.get(o);r?r.push(n):e.set(o,[n])}function cn(e,o,n){let r=new Map,t=[];for(let d of e)r.set(d.hash,!1);let i=o.firstElementChild,s;for(;i;)s=i.getAttribute("cgHash"),r.has(s)?r.set(s,!0):t.push(i),i=i.nextElementSibling;for(let d of t)o.removeChild(d);for(let d of e)r.get(d.hash)||o.appendChild(n(d))}function dn(e,o){let r=e.drawable.autoShapes.filter(t=>t.piece).map(t=>({shape:t,hash:br(t),current:!1}));cn(r,o,t=>gr(e,t,e.dom.bounds()))}function un(e){let o=y(e),n=G(e.dom.bounds()),r=e.dom.elements.autoPieces?.firstChild;for(;r;)Be(r,n(m(r.cgKey),o),r.cgScale),r=r.nextSibling}function gr(e,{shape:o,hash:n},r){let t=o.orig,i=o.piece?.role,s=o.piece?.color,d=o.piece?.scale,c=K("piece",`${i} ${s}`);return c.setAttribute("cgHash",n),c.cgKey=t,c.cgScale=d,Be(c,G(r)(m(t),y(e)),d),c}var br=e=>[e.orig,e.piece?.role,e.piece?.color,e.piece?.scale].join(",");function bt({el:e,config:o}){return yr(e,o)}function yr(e,o){let n=Go();Ne(n,o||{});function r(){let t="dom"in n?n.dom.unbind:void 0,i=Yo(e,n),s=co(()=>i.board.getBoundingClientRect()),d=l=>{tn(a),i.autoPieces&&dn(a,i.autoPieces),!l&&i.shapes&&jo(a,i)},c=()=>{io(a),an(a),i.autoPieces&&un(a)},a=n;return a.dom={elements:i,bounds:s,redraw:vr(d),redrawNow:d,unbind:t},a.drawable.prevSvgHash="",io(a),d(!1),on(a,c),t||(a.dom.unbind=nn(a,c)),a.events.insert&&a.events.insert(i),a}return Fo(r(),r)}function vr(e){let o=!1;return()=>{o||(o=!0,requestAnimationFrame(()=>{e(),o=!1}))}}export{yr as Chessground,bt as initModule};
